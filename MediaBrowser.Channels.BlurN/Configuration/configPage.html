<!DOCTYPE html>
<html>
<head>
    <title>BlurN</title>
</head>
<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage BlurNConfigurationPage" data-require="emby-button,emby-input,emby-checkbox">

        <div data-role="content">
            <div class="content-primary">
                <form class="BlurNConfigurationForm">
                    <div class="inputContainer">
                        <input is="emby-input" type="text" id="txtLastPublishDate" label="Last publish date:" disabled="disabled" />
                    </div>
                    <div class="inputContainer">
                        <input is="emby-input" type="text" id="txtAge" label="Maximum age in days:" />
                        <div class="fieldDescription">
                            Number of days elapsed since it was released to cinema. (Default is 365)
                        </div>
                    </div>
                    <div class="inputContainer">
                        <input is="emby-input" type="text" id="txtMinimumIMDBRating" label="Minimum IMDb rating:" />
                        <div class="fieldDescription">
                            Decimal value from 0 to 10. (Default is 7.0)
                        </div>
                    </div>
                    <div class="inputContainer">
                        <input is="emby-input" type="text" id="txtMinimumIMDBVotes" label="Minimum number of IMDb votes:" />
                        <div class="fieldDescription">
                            The more famous the movie the more votes it will tend to get. (Default is 1000)
                        </div>
                    </div>
                    <label class="checkboxContainer">
                        <input is="emby-checkbox" type="checkbox" id="chkAddItemsAlreadyInLibrary" />
                        <span>Add movies to BlurN even if they already exist in your Emby movie library (Default is checked)</span>
                    </label>
                    <label class="checkboxContainer">
                        <input is="emby-checkbox" type="checkbox" id="chkNotifications" />
                        <span>Enable notifications on new matching releases (Default is checked)</span>
                    </label>
                    <label class="checkboxContainer">
                        <input is="emby-checkbox" type="checkbox" id="chkDebugLogging" />
                        <span>Enable BlurN debug logging (Default is unchecked)</span>
                    </label>

                    <p>Like my plugin? Buy me a drink!</p>
                    <p><a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=RHMS9UKYKSMM8" target="_blank"><img src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" /></a></p>

                    <div>
                        <button is="emby-button" type="button" class="raised button-cancel block" id="resetDatabase">
                            <span>Reset BlurN database</span>
                        </button>
                    </div>
                    <br />
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block"><span>Save</span></button>
                    </div>


                </form>
            </div>
        </div>


        <script type="text/javascript">
            function showLastPublishedDate(page, date)
            {
                var d = new Date(date);
                function pad(n) { return n < 10 ? '0' + n : n }
                $('#txtLastPublishDate', page).val(d.getUTCFullYear() + '-'
                + pad(d.getUTCMonth() + 1) + '-'
                + pad(d.getUTCDate()));
            }
            var BlurNConfigurationPage = {
                pluginUniqueId: "08D13692-D214-47DF-B9BD-2868870C5961"
            };
            $('.BlurNConfigurationPage').on('pageinit', function (event) {
                var page = this;
                $('#resetDatabase', page).on('click', function (event) {
                    resetDatabase(page, this.getAttribute('data-id'));
                });
            });
            $('.BlurNConfigurationPage').on('pageshow', function (event) {
                Dashboard.showLoadingMsg();
                var page = this;
                ApiClient.getPluginConfiguration(BlurNConfigurationPage.pluginUniqueId).then(function (config) {
                    showLastPublishedDate(page, config.LastPublishDate);
                    $('#txtAge', page).val(config.Age || "");
                    $('#txtMinimumIMDBRating', page).val(config.MinimumIMDBRating || "");
                    $('#txtMinimumIMDBVotes', page).val(config.MinimumIMDBVotes || "");
                    $('#chkAddItemsAlreadyInLibrary', page).checked(config.AddItemsAlreadyInLibrary || false).checkboxradio("refresh");
                    $('#chkNotifications', page).checked(config.EnableNewReleaseNotification || false).checkboxradio("refresh");
                    $('#chkDebugLogging', page).checked(config.EnableDebugLogging || false).checkboxradio("refresh");
                    Dashboard.hideLoadingMsg();
                });
            });
            $('.BlurNConfigurationForm').on('submit', function (e) {
                Dashboard.showLoadingMsg();
                var form = this;
                ApiClient.getPluginConfiguration(BlurNConfigurationPage.pluginUniqueId).then(function (config) {
                    config.Age = $('#txtAge', form).val();
                    config.MinimumIMDBRating = $('#txtMinimumIMDBRating', form).val();
                    config.MinimumIMDBVotes = $('#txtMinimumIMDBVotes', form).val();
                    config.AddItemsAlreadyInLibrary = $('#chkAddItemsAlreadyInLibrary', form).checked();
                    config.EnableDebugLogging = $('#chkDebugLogging', form).checked();
                    config.EnableNewReleaseNotification = $('#chkNotifications', form).checked();
                    ApiClient.updatePluginConfiguration(BlurNConfigurationPage.pluginUniqueId, config).then(Dashboard.processPluginConfigurationUpdateResult);
                });
                // Disable default form submission
                return false;
            });
            function resetDatabase(page, id) {
                Dashboard.confirm('Are you sure you want to reset the BlurN database?', 'Confirm Database Reset', function (result) {
                    if (result) {
                        Dashboard.showLoadingMsg();
                        ApiClient.getPluginConfiguration(BlurNConfigurationPage.pluginUniqueId).then(function (config) {
                            config.LastPublishDate = new Date('2017-01-01T00:00:00.0000000Z');
                            
                            ApiClient.updatePluginConfiguration(BlurNConfigurationPage.pluginUniqueId, config).then(function () {
                                showLastPublishedDate(page, config.LastPublishDate);
                                Dashboard.processPluginConfigurationUpdateResult;
                            });
                        });
                        Dashboard.hideLoadingMsg();
                    }
                });
            }
        </script>
    </div>
</body>
</html>